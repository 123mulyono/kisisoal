<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplikasi Kisi-Kisi Soal (Simpan Otomatis)</title>

    <!-- Tailwind + jsPDF + autoTable -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      textarea {
        resize: vertical;
        min-height: 50px;
      }
      @media print {
        .no-print {
          display: none;
        }
      }
      .checkbox-label {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
      }
      .checkbox-label input {
        margin-right: 8px;
      }
      #saveStatus {
        transition: opacity 0.5s ease-in-out;
      }
      .dragging {
        opacity: 0.5;
        background: #fef3c7;
      }
    </style>
  </head>

  <body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8">
      <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
        <!-- Header -->
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold uppercase text-gray-800">Kisi-Kisi Soal</h1>
          <input
            id="assessmentType"
            type="text"
            class="form-input mt-1 text-center text-lg w-full font-semibold text-gray-700 border-0 border-b-2 border-gray-200 focus:ring-0 focus:border-blue-500 transition"
            value="Asesmen Sumatif Tengah Semester 1"
          />
          <input
            id="academicYear"
            type="text"
            class="form-input mt-1 text-center text-lg w-full font-semibold text-gray-700 border-0 border-b-2 border-gray-200 focus:ring-0 focus:border-blue-500 transition"
            value="Tahun Ajaran 2025/2026"
          />
        </div>

        <!-- Informasi Umum -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 mb-8">
          <div>
            <label for="kelasSemester" class="block text-sm font-medium text-gray-600">Kelas/Term/Semester</label>
            <input type="text" id="kelasSemester" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Contoh: X / Ganjil" />
          </div>
          <div>
            <label for="waktu" class="block text-sm font-medium text-gray-600">Waktu</label>
            <input type="text" id="waktu" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Contoh: 120 Menit" />
          </div>
          <div>
            <label for="mataPelajaran" class="block text-sm font-medium text-gray-600">Mata Pelajaran</label>
            <input type="text" id="mataPelajaran" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Contoh: Bahasa Indonesia" />
          </div>
          <div>
            <label for="jumlahSoal" class="block text-sm font-medium text-gray-600">Jumlah Soal</label>
            <input type="text" id="jumlahSoal" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Contoh: 25 Pilihan Ganda, 5 Esai" />
          </div>
          <div>
            <label for="penulis" class="block text-sm font-medium text-gray-600">Penulis</label>
            <input type="text" id="penulis" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Nama Guru" />
          </div>
        </div>

        <!-- Tombol Aksi -->
        <div class="flex items-center justify-between mb-4 no-print">
          <div class="flex items-center space-x-2">
            <h2 class="text-xl font-semibold text-gray-800">Isi Kisi-Kisi</h2>
            <span id="saveStatus" class="text-sm text-gray-500 opacity-0">Menyimpan...</span>
          </div>
          <div class="flex items-center space-x-2">
            <button id="addRowBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Tambah Baris</button>
            <button id="exportPdfBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Export ke PDF</button>
          </div>
        </div>

        <!-- Tabel Kisi-Kisi -->
        <div class="overflow-x-auto">
          <table id="kisiKisiTable" class="min-w-full border border-gray-300">
            <thead class="bg-gray-100">
              <tr>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 w-12">No</th>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">Capaian Pembelajaran</th>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">Tujuan Pembelajaran</th>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">Materi</th>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">Indikator Soal</th>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">Level Kognitif</th>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">Bentuk Soal</th>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700">Nomor Soal</th>
                <th class="border border-gray-300 px-2 py-2 text-sm font-semibold text-gray-700 no-print">Aksi</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- Rows dynamically added -->
            </tbody>
          </table>
        </div>

        <p class="text-xs text-gray-400 mt-4 no-print">ID Dokumen (untuk kolaborasi): <span id="docId" class="font-mono bg-gray-200 px-1 rounded"></span></p>

        <!-- Bagian Tanda Tangan -->
        <div class="mt-8 pt-6 border-t border-gray-200 no-print">
          <div class="flex items-center justify-center mb-6">
            <h2 class="text-xl font-semibold text-gray-800 text-center bg-gradient-to-r from-orange-400 to-red-500 text-white py-2 px-6 rounded-lg shadow-md">Data Tanda Tangan</h2>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4">
            <div>
              <div class="mb-4">
                <label for="namaKepsek" class="block text-sm font-medium text-gray-600">Nama Kepala Sekolah</label>
                <input type="text" id="namaKepsek" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Nama Lengkap Kepala Sekolah" />
              </div>
              <div class="mb-4">
                <label for="nipKepsek" class="block text-sm font-medium text-gray-600">NIP Kepala Sekolah</label>
                <input type="text" id="nipKepsek" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="NIP/NIK Kepala Sekolah" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Tanda Tangan Kepala Sekolah</label>
                <button type="button" onclick="document.getElementById('ttdKepsekInput').click()" class="mt-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Unggah TTD</button>
                <input type="file" id="ttdKepsekInput" class="hidden" accept="image/png, image/jpeg" />
                <div class="mt-2 border border-dashed border-gray-300 rounded-lg p-2 h-24 w-48 flex items-center justify-center bg-gray-50">
                  <img id="ttdKepsekPreview" src="" alt="Preview TTD Kepsek" class="max-h-full max-w-full" style="display: none" />
                </div>
              </div>
            </div>

            <div>
              <div class="mb-4">
                <label for="kotaTanggal" class="block text-sm font-medium text-gray-600">Kota & Tanggal</label>
                <input type="text" id="kotaTanggal" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Contoh: Sidoarjo, 10 September 2025" />
              </div>
              <div class="mb-4">
                <label for="namaPenyusun" class="block text-sm font-medium text-gray-600">Nama Penyusun</label>
                <input type="text" id="namaPenyusun" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Nama Guru Penyusun" />
              </div>
              <div class="mb-4">
                <label for="nipPenyusun" class="block text-sm font-medium text-gray-600">NIP Penyusun</label>
                <input type="text" id="nipPenyusun" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="NIP/NIK Penyusun" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Tanda Tangan Penyusun</label>
                <button type="button" onclick="document.getElementById('ttdPenyusunInput').click()" class="mt-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Unggah TTD</button>
                <input type="file" id="ttdPenyusunInput" class="hidden" accept="image/png, image/jpeg" />
                <div class="mt-2 border border-dashed border-gray-300 rounded-lg p-2 h-24 w-48 flex items-center justify-center bg-gray-50">
                  <img id="ttdPenyusunPreview" src="" alt="Preview TTD Penyusun" class="max-h-full max-w-full" style="display: none" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- KONFIGURASI FIREBASE (demo fallback untuk lokal) ---
      const firebaseConfig = typeof __firebase_config !== "undefined" ? JSON.parse(__firebase_config) : { apiKey: "DEMO_KEY", authDomain: "DEMO.firebaseapp.com", projectId: "DEMO_PROJECT_ID" };
      const appId = typeof __app_id !== "undefined" ? __app_id : "kisi-kisi-soal-default";
      const docId = `kisi-kisi-data-${appId}`;
      document.getElementById("docId").textContent = docId;

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const kisiKisiRef = doc(db, "artifacts", appId, "public", "data", "kisi-kisi-sheets", docId);

      // Elemen & state
      const tableBody = document.getElementById("tableBody");
      const saveStatus = document.getElementById("saveStatus");
      let debounceTimer;
      let kopImageData = null;
      let ttdPenyusunData = null;
      let ttdKepsekData = null;
      let isDataLoaded = false;

      // --- MEMUAT GAMBAR jadi base64 (mendukung Blob atau URL) ---
      const loadImageData = (source) => {
        return new Promise((resolve) => {
          // Blob (file upload / fetch blob)
          if (source instanceof Blob) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = new Image();
              img.onload = () => resolve({ base64: e.target.result, width: img.width, height: img.height });
              img.onerror = () => resolve(null);
              img.src = e.target.result;
            };
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(source);
            return;
          }
          // URL / base64 string
          if (typeof source === "string") {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // coba dapatkan cross-origin jika memungkinkan
            img.onload = () => {
              const canvas = document.createElement("canvas");
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0);
              try {
                const base64 = canvas.toDataURL("image/png");
                resolve({ base64, width: img.width, height: img.height });
              } catch (err) {
                resolve(null);
              }
            };
            img.onerror = () => resolve(null);
            img.src = source;
            return;
          }
          resolve(null);
        });
      };

      // --- File upload tanda tangan ---
      const handleFileUpload = async (file, target, previewElementId) => {
        if (!file) return;
        const imageData = await loadImageData(file);
        if (imageData) {
          if (target === "penyusun") ttdPenyusunData = imageData;
          else if (target === "kepsek") ttdKepsekData = imageData;

          const preview = document.getElementById(previewElementId);
          preview.src = imageData.base64;
          preview.style.display = "block";
          debouncedSaveData();
        }
      };

      document.getElementById("ttdPenyusunInput").addEventListener("change", (e) => handleFileUpload(e.target.files[0], "penyusun", "ttdPenyusunPreview"));
      document.getElementById("ttdKepsekInput").addEventListener("change", (e) => handleFileUpload(e.target.files[0], "kepsek", "ttdKepsekPreview"));

      // --- Debounce & Save ---
      const debounce = (func, delay) => {
        return function (...args) {
          clearTimeout(debounceTimer);
          saveStatus.style.opacity = "1";
          debounceTimer = setTimeout(() => {
            func.apply(this, args);
            setTimeout(() => (saveStatus.style.opacity = "0"), 1000);
          }, delay);
        };
      };

      const collectData = () => {
        const rows = [];
        tableBody.querySelectorAll("tr").forEach((tr) => {
          // Ambil level kognitif (td 6) dan bentuk soal (td 7) + custom jika ada
          const levelKognitif = Array.from(tr.querySelectorAll("td:nth-child(6) input[type='checkbox']:checked")).map((cb) => cb.value);
          const bentukChecked = Array.from(tr.querySelectorAll("td:nth-child(7) input[type='checkbox']:checked"));
          const bentukSoal = bentukChecked.map((cb) => {
            if (cb.classList.contains("bentuk-custom-checkbox")) {
              const txt = tr.querySelector(".bentuk-custom-text");
              return txt ? txt.value.trim() || "Lainnya" : "Lainnya";
            }
            return cb.value;
          });

          const rowData = {
            cp: tr.querySelector("td:nth-child(2) textarea").value,
            tp: tr.querySelector("td:nth-child(3) textarea").value,
            materi: tr.querySelector("td:nth-child(4) textarea").value,
            indikator: tr.querySelector("td:nth-child(5) textarea").value,
            levelKognitif,
            bentukSoal,
            customSoal: tr.querySelector(".bentuk-custom-text") ? tr.querySelector(".bentuk-custom-text").value : "",
            nomorSoal: tr.querySelector("td:nth-child(8) input").value,
          };
          rows.push(rowData);
        });

        return {
          assessmentType: document.getElementById("assessmentType").value,
          academicYear: document.getElementById("academicYear").value,
          kelasSemester: document.getElementById("kelasSemester").value,
          waktu: document.getElementById("waktu").value,
          mataPelajaran: document.getElementById("mataPelajaran").value,
          jumlahSoal: document.getElementById("jumlahSoal").value,
          penulis: document.getElementById("penulis").value,
          kotaTanggal: document.getElementById("kotaTanggal").value,
          namaPenyusun: document.getElementById("namaPenyusun").value,
          nipPenyusun: document.getElementById("nipPenyusun").value,
          namaKepsek: document.getElementById("namaKepsek").value,
          nipKepsek: document.getElementById("nipKepsek").value,
          ttdPenyusun: ttdPenyusunData,
          ttdKepsek: ttdKepsekData,
          rows,
        };
      };

      const saveData = async () => {
        if (!auth.currentUser) return; // hanya simpan bila terautentikasi
        const data = collectData();
        try {
          await setDoc(kisiKisiRef, data, { merge: true });
          console.log("Data saved to Firestore.");
        } catch (error) {
          console.error("Error saving data to Firestore:", error);
        }
      };

      const debouncedSaveData = debounce(saveData, 1500);

      // --- Render data dari Firestore ke tampilan ---
      const renderData = (data) => {
        const d = data || {};
        document.getElementById("assessmentType").value = d.assessmentType || "Asesmen Sumatif Tengah Semester 1";
        document.getElementById("academicYear").value = d.academicYear || "Tahun Ajaran 2025/2026";
        document.getElementById("kelasSemester").value = d.kelasSemester || "";
        document.getElementById("waktu").value = d.waktu || "";
        document.getElementById("mataPelajaran").value = d.mataPelajaran || "";
        document.getElementById("jumlahSoal").value = d.jumlahSoal || "";
        document.getElementById("penulis").value = d.penulis || "";
        document.getElementById("kotaTanggal").value = d.kotaTanggal || "";
        document.getElementById("namaPenyusun").value = d.namaPenyusun || d.penulis || "";
        document.getElementById("nipPenyusun").value = d.nipPenyusun || "";
        document.getElementById("namaKepsek").value = d.namaKepsek || "";
        document.getElementById("nipKepsek").value = d.nipKepsek || "";

        if (d.ttdPenyusun && d.ttdPenyusun.base64) {
          ttdPenyusunData = d.ttdPenyusun;
          const preview = document.getElementById("ttdPenyusunPreview");
          preview.src = d.ttdPenyusun.base64;
          preview.style.display = "block";
        }
        if (d.ttdKepsek && d.ttdKepsek.base64) {
          ttdKepsekData = d.ttdKepsek;
          const preview = document.getElementById("ttdKepsekPreview");
          preview.src = d.ttdKepsek.base64;
          preview.style.display = "block";
        }

        // Isi tabel
        tableBody.innerHTML = "";
        if (d.rows && d.rows.length > 0) {
          d.rows.forEach((rowData) => addRow(false, rowData));
        } else {
          addRow(false); // satu baris kosong default
        }
        updateRowNumbers();
      };

      // --- Menambah baris --- (termasuk opsi level (6) & bentuk (default 5 + custom))
      const addRow = (shouldSave = true, data = {}) => {
        const tr = document.createElement("tr");
        tr.classList.add("bg-white", "hover:bg-gray-50", "form-input");
        tr.setAttribute("draggable", "true");

        tr.innerHTML = `
          <td class="border border-gray-300 px-2 py-2 text-center row-number font-medium text-gray-600"></td>
          <td class="border border-gray-300 p-1"><textarea class="w-full border-gray-200 rounded-md shadow-sm text-sm p-2">${data.cp || ""}</textarea></td>
          <td class="border border-gray-300 p-1"><textarea class="w-full border-gray-200 rounded-md shadow-sm text-sm p-2">${data.tp || ""}</textarea></td>
          <td class="border border-gray-300 p-1"><textarea class="w-full border-gray-200 rounded-md shadow-sm text-sm p-2">${data.materi || ""}</textarea></td>
          <td class="border border-gray-300 p-1"><textarea class="w-full border-gray-200 rounded-md shadow-sm text-sm p-2">${data.indikator || ""}</textarea></td>
          <td class="border border-gray-300 px-3 py-2 text-sm">
            ${["Memahami", "Mengaplikasi", "Merefleksi", "Access and Retrieve", "Interprete and Integrate", "Evaluate and Reflect"]
              .map((val) => `<label class="checkbox-label"><input type="checkbox" value="${val}" ${(data.levelKognitif || []).includes(val) ? "checked" : ""}> ${val}</label>`)
              .join("")}
          </td>
          <td class="border border-gray-300 px-3 py-2 text-sm">
            ${["PG", "PGK", "Menjodohkan", "Isian", "Esai"].map((val) => `<label class="checkbox-label"><input type="checkbox" value="${val}" ${(data.bentukSoal || []).includes(val) ? "checked" : ""}> ${val}</label>`).join("")}
            <label class="checkbox-label">
              <input type="checkbox" class="bentuk-custom-checkbox" value="Custom" ${(data.bentukSoal || []).some((s) => s === (data.customSoal || "") || s === "Custom") ? "checked" : ""}>
              <input type="text" class="bentuk-custom-text border rounded px-1 text-sm w-32" value="${data.customSoal || ""}" placeholder="Lainnya..." />
            </label>
          </td>
          <td class="border border-gray-300 p-1"><input type="text" class="w-full border-gray-200 rounded-md shadow-sm text-sm p-2" value="${data.nomorSoal || ""}" /></td>
          <td class="border border-gray-300 p-1 text-center no-print space-x-1">
              <button class="move-up-btn bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded-md text-xs">↑</button>
              <button class="move-down-btn bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded-md text-xs">↓</button>
              <button class="delete-row-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-md text-xs">Hapus</button>
          </td>
        `;

        tableBody.appendChild(tr);
        updateRowNumbers();
        if (shouldSave) debouncedSaveData();
      };

      const updateRowNumbers = () => {
        tableBody.querySelectorAll("tr").forEach((row, index) => {
          row.querySelector(".row-number").textContent = index + 1;
        });
      };

      // Event klik: hapus / up / down
      document.getElementById("kisiKisiTable").addEventListener("click", function (e) {
        const row = e.target.closest("tr");
        if (!row) return;

        if (e.target.classList.contains("delete-row-btn")) {
          row.remove();
          updateRowNumbers();
          debouncedSaveData();
        }

        if (e.target.classList.contains("move-up-btn")) {
          const prev = row.previousElementSibling;
          if (prev) {
            row.parentNode.insertBefore(row, prev);
            updateRowNumbers();
            debouncedSaveData();
          }
        }

        if (e.target.classList.contains("move-down-btn")) {
          const next = row.nextElementSibling;
          if (next) {
            row.parentNode.insertBefore(next, row);
            updateRowNumbers();
            debouncedSaveData();
          }
        }
      });

      // Delegated input listener (auto-save saat ada perubahan di tabel atau informasi umum)
      document.addEventListener("input", (e) => {
        // Simpel: kalau input/textarea ada di dalam container (tabel atau info umum) -> save
        if (
          e.target.closest("#tableBody") ||
          e.target.closest(".form-input") ||
          ["assessmentType", "academicYear", "kelasSemester", "waktu", "mataPelajaran", "jumlahSoal", "penulis", "kotaTanggal", "namaPenyusun", "nipPenyusun", "namaKepsek", "nipKepsek"].includes(e.target.id)
        ) {
          debouncedSaveData();
        }
      });

      // Drag & Drop reorder
      tableBody.addEventListener("dragstart", (e) => {
        const tr = e.target.closest("tr");
        if (!tr) return;
        tr.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      });

      tableBody.addEventListener("dragover", (e) => {
        e.preventDefault();
        const dragging = document.querySelector(".dragging");
        if (!dragging) return;
        const afterRow = getDragAfterRow(tableBody, e.clientY);
        if (afterRow == null) tableBody.appendChild(dragging);
        else tableBody.insertBefore(dragging, afterRow);
      });

      tableBody.addEventListener("dragend", () => {
        const dragging = document.querySelector(".dragging");
        if (dragging) dragging.classList.remove("dragging");
        updateRowNumbers();
        debouncedSaveData();
      });

      function getDragAfterRow(container, y) {
        const rows = [...container.querySelectorAll("tr:not(.dragging)")];
        return rows.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      // Tombol tambah
      document.getElementById("addRowBtn").addEventListener("click", () => addRow(true));

      // Muat kop.png via fetch -> blob -> base64
      (async () => {
        try {
          const response = await fetch("kop.png");
          if (response.ok) {
            const blob = await response.blob();
            kopImageData = await loadImageData(blob);
            console.log("Kop berhasil dimuat");
          } else {
            console.warn("kop.png tidak ditemukan (response not ok).");
          }
        } catch (err) {
          console.warn("Gagal memuat kop.png:", err);
        }
      })();

      // --- AUTENTIKASI & SYNC DENGAN FIRESTORE ---
      (async () => {
        try {
          if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
          onAuthStateChanged(auth, (user) => {
            if (user) {
              onSnapshot(
                kisiKisiRef,
                (docSnap) => {
                  if (docSnap.exists()) {
                    renderData(docSnap.data());
                  } else {
                    // create with default row
                    renderData(null);
                    saveData();
                  }
                  isDataLoaded = true;
                },
                (err) => console.error("onSnapshot error:", err)
              );
            }
          });
        } catch (err) {
          console.error("Authentication failed:", err);
        }
      })();

      // Export PDF (pakai autoTable seperti sebelumnya)
      const generatePDF = (kopInfo) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

        let currentY = 0;

        if (kopInfo) {
          const pageMargin = 40;
          const pageWidth = doc.internal.pageSize.getWidth();
          const imgWidth = pageWidth - pageMargin * 2;
          const imgHeight = (kopInfo.height * imgWidth) / kopInfo.width;
          doc.addImage(kopInfo.base64, "PNG", pageMargin, 20, imgWidth, imgHeight);
          currentY = 20 + imgHeight + 20;
        } else {
          currentY = 40;
        }

        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("KISI-KISI SOAL", doc.internal.pageSize.getWidth() / 2, currentY, { align: "center" });
        currentY += 20;

        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.text(document.getElementById("assessmentType").value.toUpperCase(), doc.internal.pageSize.getWidth() / 2, currentY, { align: "center" });
        currentY += 15;
        doc.text(document.getElementById("academicYear").value.toUpperCase(), doc.internal.pageSize.getWidth() / 2, currentY, { align: "center" });
        currentY += 25;

        const infoStartX = 40,
          infoLineHeight = 15;
        let infoStartY = currentY;
        doc.setFontSize(10);
        doc.text("Kelas/Term/Semester", infoStartX, infoStartY);
        doc.text(`: ${document.getElementById("kelasSemester").value}`, infoStartX + 120, infoStartY);
        doc.text("Mata Pelajaran", infoStartX, infoStartY + infoLineHeight);
        doc.text(`: ${document.getElementById("mataPelajaran").value}`, infoStartX + 120, infoStartY + infoLineHeight);

        const rightInfoStartX = doc.internal.pageSize.getWidth() / 2 + 60;
        doc.text("Waktu", rightInfoStartX, infoStartY);
        doc.text(`: ${document.getElementById("waktu").value}`, rightInfoStartX + 80, infoStartY);
        doc.text("Jumlah Soal", rightInfoStartX, infoStartY + infoLineHeight);
        doc.text(`: ${document.getElementById("jumlahSoal").value}`, rightInfoStartX + 80, infoStartY + infoLineHeight);
        doc.text("Penulis", rightInfoStartX, infoStartY + infoLineHeight * 2);
        doc.text(`: ${document.getElementById("penulis").value}`, rightInfoStartX + 80, infoStartY + infoLineHeight * 2);

        // Table data
        const tableData = [];
        collectData().rows.forEach((row, index) => {
          tableData.push([index + 1, row.cp, row.tp, row.materi, row.indikator, row.levelKognitif.map((v) => `\u2022 ${v}`).join("\n"), row.bentukSoal.map((v) => `\u2022 ${v}`).join("\n"), row.nomorSoal]);
        });

        doc.autoTable({
          head: [["No", "Capaian Pembelajaran", "Tujuan Pembelajaran", "Materi", "Indikator Soal", "Level Kognitif", "Bentuk Soal", "Nomor Soal"]],
          body: tableData,
          startY: infoStartY + infoLineHeight * 3 + 10,
          theme: "grid",
          headStyles: { fillColor: [230, 230, 230], textColor: [30, 30, 30], fontStyle: "bold" },
          styles: { lineWidth: 0.5, lineColor: [150, 150, 150], fontSize: 9 },
          didParseCell: function (data) {
            if (data.section === "head") data.cell.styles.halign = "center";
            if (data.column.index === 0) data.cell.styles.halign = "center";
          },
        });

        // Tanda tangan
        const lastPage = doc.internal.getNumberOfPages();
        doc.setPage(lastPage);
        let finalY = doc.autoTable.previous ? doc.autoTable.previous.finalY : 60;
        const pageHeight = doc.internal.pageSize.getHeight();
        const signatureBlockHeight = 130;

        if (finalY + signatureBlockHeight > pageHeight - 40) {
          doc.addPage();
          finalY = 40;
        } else {
          finalY += 30;
        }

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageMargin = 40;
        const leftBlockX = pageMargin;
        const rightBlockX = pageWidth - pageMargin;

        const kotaTanggal = document.getElementById("kotaTanggal").value;
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(kotaTanggal, rightBlockX, finalY, { align: "right" });

        let signatureStartY = finalY + 30;
        doc.text("Mengetahui,", leftBlockX, signatureStartY);
        doc.text("Kepala Sekolah", leftBlockX, signatureStartY + 15);
        doc.text("Penyusun", rightBlockX, signatureStartY + 15, { align: "right" });

        let ttdY = signatureStartY + 25;
        const ttdHeight = 50;

        if (ttdKepsekData) {
          const sigWidth = 60;
          const sigHeight = (ttdKepsekData.height * sigWidth) / ttdKepsekData.width;
          doc.addImage(ttdKepsekData.base64, "PNG", leftBlockX, ttdY, sigWidth, sigHeight);
        }
        if (ttdPenyusunData) {
          const sigWidth = 60;
          const sigHeight = (ttdPenyusunData.height * sigWidth) / ttdPenyusunData.width;
          const penyusunSigX = rightBlockX - sigWidth;
          doc.addImage(ttdPenyusunData.base64, "PNG", penyusunSigX, ttdY, sigWidth, sigHeight);
        }

        let namesY = ttdY + ttdHeight + 10;
        const namaPenyusun = document.getElementById("namaPenyusun").value;
        const nipPenyusun = `NIP. ${document.getElementById("nipPenyusun").value}`;
        const namaKepsek = document.getElementById("namaKepsek").value;
        const nipKepsek = `NIP. ${document.getElementById("nipKepsek").value}`;

        doc.setFont("helvetica", "bold");
        doc.text(namaKepsek, leftBlockX, namesY);
        doc.line(leftBlockX, namesY + 2, leftBlockX + doc.getTextWidth(namaKepsek), namesY + 2);
        doc.text(namaPenyusun, rightBlockX, namesY, { align: "right" });
        const namaPenyusunWidth = doc.getTextWidth(namaPenyusun);
        doc.line(rightBlockX - namaPenyusunWidth, namesY + 2, rightBlockX, namesY + 2);

        let nipY = namesY + 15;
        doc.setFont("helvetica", "normal");
        doc.text(nipKepsek, leftBlockX, nipY);
        doc.text(nipPenyusun, rightBlockX, nipY, { align: "right" });

        doc.save("kisi-kisi-soal.pdf");
      };

      document.getElementById("exportPdfBtn").addEventListener("click", () => {
        generatePDF(kopImageData);
      });
    </script>
  </body>
</html>
